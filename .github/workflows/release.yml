name: Release Snake Game
on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release'
        required: true
        default: 'v1.5.0'

jobs:
  release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: Linux
            arch: x64
          - os: windows-latest
            platform: Windows
            arch: x64
          - os: macos-latest
            platform: macOS
            arch: universal

    name: Release for ${{ matrix.platform }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.cache/pyinstaller
        key: release-${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          release-${{ runner.os }}-pip-

    - name: Install UPX (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y upx-ucl
        echo "âœ… UPX installed: $(upx --version | head -1)"

    - name: Install UPX (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install upx
        echo "âœ… UPX installed: $(upx --version | head -1)"

    - name: Setup UPX (Windows)
      if: runner.os == 'Windows'
      run: |
        if (-not (Test-Path "lib")) { New-Item -ItemType Directory -Path "lib" }
        if (-not (Test-Path "lib/upx.exe")) {
          Write-Host "ðŸ“¥ Downloading UPX for Windows release..."
          Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v4.2.1/upx-4.2.1-win64.zip" -OutFile "upx.zip"
          Expand-Archive "upx.zip" -DestinationPath "."
          Move-Item "upx-4.2.1-win64/upx.exe" "lib/upx.exe"
          Remove-Item "upx.zip","upx-4.2.1-win64" -Recurse -Force
          Write-Host "âœ… UPX local setup complete"
        }
        echo "${{ github.workspace }}/lib" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        & "lib/upx.exe" --version
      shell: powershell

    - name: Install dependencies (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pygame
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      shell: bash

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pygame
        if (Test-Path requirements.txt) { pip install -r requirements.txt }
      shell: powershell

    - name: Build release executable (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        echo "ðŸš€ Building Snake Game v${{ github.ref_name }} for ${{ matrix.platform }}..."
        pyinstaller --onefile --noconsole main.py -n "SnakeGame"
      shell: bash

    - name: Build release executable (Windows)
      if: runner.os == 'Windows'
      run: |
        Write-Host "ðŸš€ Building Snake Game v${{ github.ref_name }} for ${{ matrix.platform }}..."
        pyinstaller --onefile --noconsole main.py -n "SnakeGame"
      shell: powershell

    - name: Prepare release files (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        echo "ðŸ“¦ Preparing release files..."
        mkdir -p release
        EXECUTABLE_NAME="SnakeGame"
        if [ -f "dist/$EXECUTABLE_NAME" ]; then
          cp "dist/$EXECUTABLE_NAME" "release/"
          echo "âœ… Executable copied: $EXECUTABLE_NAME"
        else
          echo "âŒ Executable not found: dist/$EXECUTABLE_NAME"
          ls -la dist/ || echo "dist/ directory not found"
          exit 1
        fi

        printf "Snake Game - ParaDevOne\nVersion: ${{ github.ref_name }}\nPlatform: ${{ matrix.platform }} (${{ matrix.arch }})\nBuilt: $(date -u \"+%Y-%m-%d %H:%M:%S UTC\")\nPython Version: $(python --version)\nBuild System: GitHub Actions\n\nExecutable: $EXECUTABLE_NAME\n" > release/VERSION.txt

        for file in README.md LICENSE CHANGELOG.md; do
          if [ -f "$file" ]; then
            cp "$file" "release/"
            echo "ðŸ“„ Added: $file"
          fi
        done

        for folder in assets sounds images fonts config Data; do
          if [ -d "$folder" ]; then
            cp -r "$folder" "release/"
            echo "ðŸ“ Added folder: $folder"
          fi
        done

        echo "ðŸ“ Release files prepared:"
        ls -la release/
      shell: bash

    - name: Prepare release files (Windows)
      if: runner.os == 'Windows'
      run: |
        Write-Host "ðŸ“¦ Preparing release files..."
        New-Item -ItemType Directory -Path release -Force | Out-Null
        $exe = "dist\SnakeGame.exe"
        if (Test-Path $exe) {
          Copy-Item $exe -Destination release\
          Write-Host "âœ… Executable copied: SnakeGame.exe"
        } else {
          Write-Host "âŒ Executable not found: $exe"
          Get-ChildItem dist -Force | Write-Host
          exit 1
        }

        # Escribimos VERSION.txt lÃ­nea por lÃ­nea para evitar here-strings que rompen YAML
        Set-Content -Path release\VERSION.txt -Value "Snake Game - ParaDevOne"
        Add-Content -Path release\VERSION.txt -Value ("Version: " + $env:GITHUB_REF_NAME)
        Add-Content -Path release\VERSION.txt -Value ("Platform: ${{ matrix.platform }} (${{ matrix.arch }})")
        Add-Content -Path release\VERSION.txt -Value ("Built: " + (Get-Date -Format "yyyy-MM-dd HH:mm:ss") + " UTC")
        $pyver = & python --version 2>&1
        Add-Content -Path release\VERSION.txt -Value ("Python Version: " + $pyver)
        Add-Content -Path release\VERSION.txt -Value "Build System: GitHub Actions"
        Add-Content -Path release\VERSION.txt -Value ""
        Add-Content -Path release\VERSION.txt -Value "Executable: SnakeGame.exe"

        foreach ($file in @("README.md","LICENSE","CHANGELOG.md")) {
          if (Test-Path $file) { Copy-Item $file -Destination release\; Write-Host "ðŸ“„ Added: $file" }
        }
        foreach ($folder in @("assets","sounds","images","fonts","config","Data")) {
          if (Test-Path $folder) { Copy-Item $folder -Recurse -Destination release\; Write-Host "ðŸ“ Added folder: $folder" }
        }
        Write-Host "ðŸ“ Release files prepared:"
        Get-ChildItem release -Force | Write-Host
      shell: powershell

    - name: Get file sizes
      id: sizes
      if: runner.os != 'Windows'
      run: |
        EXECUTABLE="release/SnakeGame"
        if [ -f "$EXECUTABLE" ]; then
          SIZE_BYTES=$(stat -c%s "$EXECUTABLE" 2>/dev/null || stat -f%z "$EXECUTABLE")
          SIZE_MB=$(echo "scale=2; $SIZE_BYTES / 1024 / 1024" | bc -l)
          echo "size_bytes=$SIZE_BYTES" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "executable=$EXECUTABLE" >> $GITHUB_OUTPUT
          echo "ðŸ“ Executable size: $SIZE_MB MB ($SIZE_BYTES bytes)"
        fi
      shell: bash

    - name: Get file sizes (Windows)
      id: sizes_windows
      if: runner.os == 'Windows'
      run: |
        $exe = "release\SnakeGame.exe"
        if (Test-Path $exe) {
          $size = (Get-Item $exe).Length
          $mb = [math]::Round($size / 1MB, 2)
          echo "size_bytes=$size" >> $env:GITHUB_OUTPUT
          echo "size_mb=$mb" >> $env:GITHUB_OUTPUT
          echo "executable=$exe" >> $env:GITHUB_OUTPUT
          Write-Host "ðŸ“ Executable size: $mb MB ($size bytes)"
        }
      shell: powershell

    - name: Create platform archive (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        cd release
        if [ "$RUNNER_OS" == "Darwin" ]; then
          ARCHIVE_NAME="SnakeGame-${{ github.ref_name }}-macOS-universal.tar.gz"
        else
          ARCHIVE_NAME="SnakeGame-${{ github.ref_name }}-Linux-x64.tar.gz"
        fi
        tar -czf "../$ARCHIVE_NAME" *
        cd ..
        echo "ðŸ“¦ Created archive: $ARCHIVE_NAME"
        echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_ENV
        ls -lh "$ARCHIVE_NAME"
      shell: bash

    - name: Create platform archive (Windows)
      if: runner.os == 'Windows'
      run: |
        $archive = "SnakeGame-${{ github.ref_name }}-Windows-x64.zip"
        powershell -Command "Compress-Archive -Path 'release/*' -DestinationPath '../$archive' -Force"
        echo "archive_name=$archive" >> $env:GITHUB_ENV
        Write-Host "ðŸ“¦ Created archive: $archive"
        Get-ChildItem ..\$archive | Format-List
      shell: powershell

    - name: Upload release artifacts
      uses: actions/upload-artifact@v3
      with:
        name: snake-game-release-${{ matrix.platform }}
        path: |
          ${{ env.archive_name }}
          release/
        retention-days: 90

  create-release:
    needs: release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        echo "ðŸ“¦ Preparing release assets..."
        mkdir -p release-assets
        find artifacts -name "*.zip" -o -name "*.tar.gz" | while read file; do
          cp "$file" release-assets/
          echo "ðŸ“„ Added: $(basename "$file")"
        done
        echo "ðŸŽ¯ Release assets ready:"
        ls -la release-assets/
      shell: bash

    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
# ðŸ Snake Game ${{ github.ref_name }}

**Desarrollado por ParaDevOne**

## ðŸ“¦ Descargas por Plataforma

- Windows: "SnakeGame-${{ github.ref_name }}-Windows-x64.zip"
- macOS: "SnakeGame-${{ github.ref_name }}-macOS-universal.tar.gz"
- Linux: "SnakeGame-${{ github.ref_name }}-Linux-x64.tar.gz"

## ðŸš€ InstalaciÃ³n

### Windows
1. Descarga el archivo .zip
2. Extrae en la carpeta deseada
3. Ejecuta "SnakeGame.exe"

### macOS / Linux
1. Descarga el archivo .tar.gz correspondiente
2. Extrae: tar -xzf SnakeGame-*.tar.gz
3. Ejecuta: ./SnakeGame

## ðŸ”§ CaracterÃ­sticas

- âœ… Ejecutable independiente (no requiere Python)
- âœ… Comprimido con UPX para tamaÃ±o optimizado
- âœ… Compatible con mÃºltiples resoluciones
- âœ… Incluye todos los assets necesarios

## ðŸ—ï¸ InformaciÃ³n de Build

- Python: 3.11
- Herramientas: PyInstaller + UPX
- CI/CD: GitHub Actions
- Fecha: $(date -u "+%Y-%m-%d %H:%M:%S UTC")

---
*Construido automÃ¡ticamente con GitHub Actions* ðŸ¤–
EOF

        echo "release_notes<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
      shell: bash

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release-assets/*
        body: ${{ steps.release_notes.outputs.release_notes }}
        generate_release_notes: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
